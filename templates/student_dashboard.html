<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RACE Lab Dashboard</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='icons/favicon.ico') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .component-row {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .component-row .form-group { margin-bottom: 0; }
        .component-row .form-group:first-child { flex-grow: 3; }
        .component-row .form-group:nth-child(2) { flex-grow: 1; }
        .remove-row-btn {
            background-color: var(--color-red);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.5rem;
            cursor: pointer;
            height: 40px;
            margin-top: 1.1rem;
        }
        .remove-row-btn:hover { background-color: var(--color-red-hover); }

        /* --- START: New/Modified Styles for Neatness --- */

        /* Add icons to tab buttons */
        .tab-link {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
        }
        .tab-link svg {
            width: 1.1em;
            height: 1.1em;
            opacity: 0.6;
            transition: all 0.2s ease;
        }
        .tab-link.active svg {
            opacity: 1;
        }

        /* Better spacing for headings */
        .main-tab-content h3 {
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .main-tab-content > p {
            font-size: 1rem;
            color: var(--color-text-light);
            margin-bottom: 2rem;
        }

        /* Tweak info box */
        .form-info-box {
            background-color: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-left: 4px solid var(--color-primary); /* Add a highlight */
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        .form-info-box h4 { margin-top: 0; }
        .form-info-box p {
            font-size: 0.95rem;
            line-height: 1.5;
        }

        /* Tweak add component button */
        .add-component-btn {
            background-color: #f9fafb;
            color: var(--color-text-dark);
            border: 1px dashed var(--color-grey);
            font-weight: 500;
            transition: all 0.2s ease;
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .add-component-btn:hover {
            background-color: #f3f4f6;
            border-color: var(--color-primary);
            color: var(--color-primary);
        }

        /* More spacing between forms */
        .request-form-container {
            /* Now hidden by default by JS */
            display: none;
            border-top: 1px solid #e5e7eb;
            padding-top: 2rem;
            margin-top: 2rem;
        }
        .request-form-container:first-of-type {
            margin-top: 0;
            padding-top: 0;
            border-top: none;
        }


        /* Clean up history table actions */
        .history-actions {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 80px; /* Give it space */
        }
        .history-actions .admin-btn, .history-actions a {
            padding: 0.3rem 0.6rem;
            font-size: 0.8rem;
            text-align: center;
            min-width: 60px;
        }

        /* --- NEW STYLES FOR SELECTION CARDS --- */
        #request-form-screen {
            display: none; /* Hide form screen by default */
        }

        .request-options-container {
            display: flex;
            gap: 1.5rem;
            justify-content: space-between;
        }
        .request-option-card {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 1.5rem 2rem;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
        }
        .request-option-card:hover {
            box-shadow: var(--shadow-md);
            border-color: #d1d5db;
        }
        .request-option-card-icon {
            width: 48px;
            height: 48px;
            padding: 10px;
            border-radius: 50%;
            background-color: #eef2ff;
            color: var(--color-primary);
            margin-bottom: 1rem;
        }
        .request-option-card h4 {
            font-size: 1.25rem;
            margin-top: 0;
            margin-bottom: 0.75rem;
            color: var(--color-text-dark);
        }
        .request-option-card-rules {
            font-size: 0.9rem;
            padding-left: 1.25rem;
            margin-bottom: 1.5rem;
            color: var(--color-text-light);
            flex-grow: 1; /* Pushes button to bottom */
        }
        .request-option-card-rules li {
            margin-bottom: 0.5rem;
        }
        .start-request-btn {
            width: 100%;
            background-color: var(--color-primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .start-request-btn:hover {
            background-color: var(--color-primary-hover);
        }

        #back-to-selection-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: transparent;
            border: none;
            color: var(--color-primary);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 1.5rem;
            padding: 0.25rem 0;
        }
        #back-to-selection-btn:hover {
            text-decoration: underline;
        }
        /* --- END: New/Modified Styles --- */
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand">
            <img src="{{ url_for('static', filename='bannerlogo.jpg') }}" alt="Logo" class="navbar-logo">
            RACE Lab - PORTAL
        </div>
        <div class="navbar-user">
            Logged in as: <strong>{{ user.name }} ({{ user.department }})</strong>
            <a href="{{ url_for('logout') }}" class="logout-button">Logout</a>
        </div>
    </nav>

    <div class="student-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}{% for category, message in messages %}
            <div class="flash-{{ category }}">{{ message }}</div>
            {% endfor %}{% endif %}
        {% endwith %}

        <!-- --- START: Main Tab Navigation --- -->
        <div class="tab-container">
            <!-- RE-ADDED the tab navigation -->
            <div class="tab-nav">
                <button class="tab-link active" onclick="openMainTab(event, 'request')">
                    <!-- Icon: Plus Circle -->
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                    Request Components
                </button>
                <button class="tab-link" onclick="openMainTab(event, 'history')">
                    <!-- Icon: Clock -->
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                    My Request History
                </button>
            </div>

            <!-- --- START: Tab 1 - Request Components (NEW STRUCTURE) --- -->
            <div id="request" class="main-tab-content" style="display: block;">

                <!-- STEP 1: Selection Screen (Visible by default) -->
                <div id="request-selection-screen">
                    <h3>Component Request</h3>

                    <div class="request-options-container">
                        <!-- Card 1: Intra-Day -->
                        <div class="request-option-card">
                            <div class="request-option-card-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-6.364-.386 1.591-1.591M3 12H5.25m.386-6.364 1.591 1.591M12 12a2.25 2.25 0 0 0-2.25 2.25v.01c0 .317.031.63.09.934a2.25 2.25 0 0 0 .16.906 2.25 2.25 0 0 0 .584 1.433 2.25 2.25 0 0 0 1.416.584c.304.059.617.09.934.09v-.01a2.25 2.25 0 0 0 2.25-2.25 2.25 2.25 0 0 0-2.25-2.25Zm0 0A2.25 2.25 0 0 1 14.25 12v.01c0 .317-.031.63-.09.934a2.25 2.25 0 0 1-.16.906 2.25 2.25 0 0 1-.584 1.433 2.25 2.25 0 0 1-1.416.584c-.304-.059-.617-.09-.934-.09v.01A2.25 2.25 0 0 1 9.75 12a2.25 2.25 0 0 1 2.25-2.25Z" /></svg>
                            </div>
                            <h4>1. Intra-Day Activities</h4>
                            <ul class="request-option-card-rules">
                                <li>For lab work, practice, and skill enhancement.</li>
                                <li>Components must be returned by <strong>3:00 PM on the same day</strong>.</li>
                            </ul>
                            <button class="start-request-btn" data-form-id="form-intra-day">Start Intra-Day Request</button>
                        </div>

                        <!-- Card 2: Project Work -->
                        <div class="request-option-card">
                            <div class="request-option-card-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 14.15v4.075c0 .621-.504 1.125-1.125 1.125H4.875c-.621 0-1.125-.504-1.125-1.125V14.15M21 13.5v-1.5c0-.621-.504-1.125-1.125-1.125H4.125C3.504 10.875 3 11.379 3 12v1.5m18 0v-1.5a2.25 2.25 0 0 0-2.25-2.25H5.25A2.25 2.25 0 0 0 3 12v1.5m18 0v-1.5A2.25 2.25 0 0 0 18.75 9.75h-1.5A2.25 2.25 0 0 0 15 12v1.5m-6 0v-1.5A2.25 2.25 0 0 0 6.75 9.75H5.25A2.25 2.25 0 0 0 3 12v1.5m18-3.35v.001c0 .621-.504 1.125-1.125 1.125H4.125c-.621 0-1.125-.504-1.125-1.125v-.001M15 9.75v-4.5a3 3 0 0 0-3-3h-3a3 3 0 0 0-3 3v4.5" /></svg>
                            </div>
                            <h4>2. Project Work (Inside Lab)</h4>
                            <ul class="request-option-card-rules">
                                <li>For long-term, approved project activities.</li>
                                <li>A dedicated drawer will be allotted in the lab for component storage.</li>
                                <li>All components must be placed back in the allotted drawer after each work session.</li>
                                <li>The drawer key must be returned to the Lab Technician before <strong>3:00 PM</strong> every day.</li>
                                <li>Maximum borrow period: <strong>30 days</strong>.</li>
                            </ul>
                            <button class="start-request-btn" data-form-id="form-project">Start Project Request</button>
                        </div>

                        <!-- Card 3: Competitions -->
                        <div class="request-option-card">
                            <div class="request-option-card-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 18.75h-9m9 0a3 3 0 0 1 3 3h-15a3 3 0 0 1 3-3m9 0v-3.375c0-.621-.503-1.125-1.125-1.125h-6.75c-.622 0-1.125.504-1.125 1.125v3.375m9 0h-9m9 0h1.125m-11.25 0H4.875M16.5 18.75v-3.375a3.375 3.375 0 0 0-3.375-3.375h-3.75a3.375 3.375 0 0 0-3.375 3.375v3.375m9 0h-9" /></svg>
                            </div>
                            <h4>3. Competitions</h4>
                            <ul class="request-option-card-rules">
                                <li>For official National/International competitions only.</li>
                                <li>Maximum borrow period: <strong>30 days</strong>.</li>
                            </ul>
                            <button class="start-request-btn" data-form-id="form-competition">Start Competition Request</button>
                        </div>
                    </div>
                </div>

                <!-- STEP 2: Form Screen (Hidden by default) -->
                <div id="request-form-screen">
                    <button id="back-to-selection-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width:1em; height:1em;"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" /></svg>
                        Back to Options
                    </button>

                    <!-- Availability Table is now HERE -->
                    <h3 style="margin-top: 1rem;">Component Availability</h3>
                    <p>Check stock before you request. You can only request items that are "In Stock" or "Low Stock".</p>
                    <div class="table-container" style="margin-bottom: 2rem;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Component</th>
                                    <th>Total Qty</th>
                                    <th>Working Qty</th>
                                    <th>Not Working Qty</th>
                                    <th>Issued Qty</th>
                                    <th>Available for Issue</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for component in components %}
                                <tr>
                                    <td>{{ component.name }}</td>
                                    <td>{{ component.total_quantity }}</td>
                                    <td>{{ component.working_quantity }}</td>
                                    <td>{{ component.not_working_quantity }}</td>
                                    <td>{{ component.issued_quantity }}</td>
                                    <td><strong>{{ component.available }}</strong></td>
                                    <td>
                                        {% if component.available <= 0 %}<span class="status out-of-stock">Out of Stock</span>
                                        {% elif component.available < 10 %}<span class="status low-stock">Low Stock</span>
                                        {% else %}<span class="status in-stock">In Stock</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <!-- End Availability Table -->

                    <datalist id="component-datalist">
                        {% for component in available_components %}
                        <option value="{{ component.name }}"></option>
                        {% endfor %}
                    </datalist>

                    <!-- Form 1: Intra-Day Activities -->
                    <div id="form-intra-day" class="request-form-container">
                        <div class="form-info-box">
                            <h4>Intra-Day Activity Request</h4>
                            <p style="margin: 0;"><strong>Rules:</strong> Must be returned same day 3 PM.<br> For lab work, practice, and skill enhancement.</p>
                        </div>
                        <form action="{{ url_for('request_component') }}" method="POST" class="request-form">
                            <input type="hidden" name="project_type" value="Intra-Day">
                            <h4>Components</h4>
                            <div id="component-list-intra">
                                <div class="component-row">
                                    <div class="form-group">
                                        <label for="component_1_intra">Component Name:</label>
                                        <input type="text" list="component-datalist" id="component_1_intra" name="component[]" class="component-search" placeholder="Type or select component" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="quantity_1_intra">Quantity:</label>
                                        <input type="number" id="quantity_1_intra" name="quantity[]" min="1" max="10" value="1" required>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="add-component-btn">+ Add Another Component</button>
                            <hr style="margin: 1.5rem 0;">
                            <h4>Request Details</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="return_date_intra">Expected Return Date (Must be today)</label>
                                    <input type="date" id="return_date_intra" name="return_date" value="{{ today }}" readonly required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="project_description_intra">Activity / Purpose:</label>
                                <textarea id="project_description_intra" name="project_description" rows="3" placeholder="e.g., Testing sensor for mini-project..." required></textarea>
                            </div>
                            <input type="hidden" name="mentor_name" value="N/A (Intra-Day)">
                            <input type="hidden" name="mentor_email" value="N/A">
                            <div class="disclaimer-section" style="margin-top: 20px;">
  <input type="checkbox" id="disclaimer-checkbox-intra_day" class="disclaimer-checkbox">
  <label for="disclaimer-checkbox-intra_day">
    <strong>I UNDERSTAND THAT I WILL BE RESPONSIBLE FOR LOSS/DAMAGE OF THE COMPONENT.</strong>
  </label>
</div>

<button id="submit-btn-intra_day" type="submit" class="btn btn-primary" disabled>Submit Request</button>

                        </form>
                    </div>

                    <!-- Form 2: Project Work (Inside Lab) -->
                    <div id="form-project" class="request-form-container">
                        <div class="form-info-box">
                            <h4>Project Work Request</h4>
                            <p style="margin: 0;"><strong>Rules:</strong> For long-term, approved project activities.
                                A dedicated drawer will be allotted in the lab for component storage.
                                All components must be placed back in the allotted drawer after each work session.
                                The drawer key must be returned to the Lab Technician before <strong>3:00 PM</strong> every day.
                                Maximum borrow period: <strong>30 days</strong>.</p>
                        </div>
                        <form action="{{ url_for('request_component') }}" method="POST" class="request-form">
                            <input type="hidden" name="project_type" value="Project Work">
                            <h4>Components</h4>
                            <div id="component-list-project">
                                <div class="component-row">
                                    <div class="form-group">
                                        <label for="component_1_proj">Component Name:</label>
                                        <input type="text" list="component-datalist" id="component_1_proj" name="component[]" class="component-search" placeholder="Type or select component" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="quantity_1_proj">Quantity:</label>
                                        <input type="number" id="quantity_1_proj" name="quantity[]" min="1" max="10" value="1" required>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="add-component-btn">+ Add Another Component</button>
                            <hr style="margin: 1.5rem 0;">
                            <h4>Request Details</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="return_date">Expected Return Date (Max 30 days):</label>
                                    <input type="date" id="return_date" name="return_date" min="{{ today }}" max="{{ max_date }}" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="project_description">Project Title / Description:</label>
                                <textarea id="project_description" name="project_description" rows="3" placeholder="Briefly describe your project..." required></textarea>
                            </div>
                            <input type="hidden" name="mentor_name" value="N/A (Project Work)">
                            <input type="hidden" name="mentor_email" value="N/A">
                            <div class="disclaimer-section" style="margin-top: 20px;">
  <input type="checkbox" id="disclaimer-checkbox-project" class="disclaimer-checkbox">
  <label for="disclaimer-checkbox-project">
    <strong>I UNDERSTAND THAT I WILL BE RESPONSIBLE FOR LOSS/DAMAGE OF THE COMPONENT.</strong>
  </label>
</div>

<button id="submit-btn-project" type="submit" class="btn btn-primary" disabled>Submit Request</button>

                        </form>
                    </div>

                    <!-- Form 3: Competitions -->
                    <div id="form-competition" class="request-form-container">
                        <div class="form-info-box">
                            <h4>Competition Request</h4>
                            <p style="margin: 0;"><strong>Rules:</strong> Only for National/International Competitions <br> <strong>Max 30-day borrow.</strong></p>
                        </div>
                        <form action="{{ url_for('request_component') }}" method="POST" class="request-form">
                            <input type="hidden" name="project_type" value="Competition">
                            <h4>Components</h4>
                            <div id="component-list-comp">
                                <div class="component-row">
                                    <div class="form-group">
                                        <label for="component_1_comp">Component Name:</label>
                                        <input type="text" list="component-datalist" id="component_1_comp" name="component[]" class="component-search" placeholder="Type or select component" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="quantity_1_comp">Quantity:</label>
                                        <input type="number" id="quantity_1_comp" name="quantity[]" min="1" max="10" value="1" required>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="add-component-btn">+ Add Another Component</button>
                            <hr style="margin: 1.5rem 0;">
                            <h4>Request Details</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="mentor_name_comp">Mentor Name:</label>
                                    <input type="text" id="mentor_name_comp" name="mentor_name" placeholder="Full name of your mentor" required>
                                </div>
                                <div class="form-group">
                                    <label for="mentor_email_comp">Mentor Email:</label>
                                    <input type="email" id="mentor_email_comp" name="mentor_email" placeholder="Mentor's official email" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="return_date_comp">Expected Return Date (Max 30 days):</label>
                                    <input type="date" id="return_date_comp" name="return_date" min="{{ today }}" max="{{ max_date }}" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="project_description_comp">Competition Name & Description:</label>
                                <textarea id="project_description_comp" name="project_description" rows="3" placeholder="e.g., e-Yantra 2025 - Theme..." required></textarea>
                            </div>
                            <div class="disclaimer-section" style="margin-top: 20px;">
  <input type="checkbox" id="disclaimer-checkbox-competition" class="disclaimer-checkbox">
  <label for="disclaimer-checkbox-competition">
    <strong>I UNDERSTAND THAT I WILL BE RESPONSIBLE FOR LOSS/DAMAGE OF THE COMPONENT.</strong>
  </label>
</div>

<button id="submit-btn-competition" type="submit" class="btn btn-primary" disabled>Submit Request</button>

                        </form>
                    </div>
                </div>
            </div>
            <!-- --- END: Tab 2 --- -->

            <!-- RE-ADDED the "history" div block -->
            <div id="history" class="main-tab-content" style="display: none;">
                <h3>My Request History</h3>
                <div class="table-container wide-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Req ID</th>
                                <th>Project Type</th>
                                <th>Component</th>
                                <th>Qty</th>
                                <th>Status</th>
                                <th>Mentor / Batch</th>
                                <th>Incharge Remarks</th>
                                <th>Mentor Link</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set rendered_batches = [] %}
                            {% if not my_requests %}
                                <tr><td colspan="9">You have not made any requests.</td></tr>
                            {% else %}
                                {% for req in my_requests | reverse %}
                                <tr>
                                    <td>{{ req.id }}</td>
                                    <td>
                                        <span class="status status-issued" style="background-color: #eee; color: #555; font-size: 0.75rem; padding: 0.2rem 0.4rem;">
                                            {{ req.get('project_type', 'N/A') }}
                                        </span>
                                    </td>
                                    <td>{{ req.component_name }}</td>
                                    <td>{{ req.quantity }}</td>
                                    <td>
                                        {% set status_text = req.status | replace('-', ' ') | title %}
                                        <span class="status status-{{ req.status | lower | replace(' ', '-') }}">{{ status_text }}</span>
                                    </td>
                                    <td>
                                        <small>B: {{ req.get('batch_id', 'N/A') }}</small><br>
                                        {{ req.get('mentor_name', '-') }}
                                    </td>
                                    <td><small>{{ req.get('incharge_remarks', '-') }}</small></td>
                                    <td class="history-actions">
                                        {% set batch_id = req.get('batch_id') %}
                                        {% if batch_id and req.status == 'Pending Mentor' and req.mentor_approval_token and batch_id not in rendered_batches %}
                                            <a href="{{ url_for('mentor_approval', token=req.mentor_approval_token) }}" target="_blank">Get Link</a>
                                            {% if rendered_batches.append(batch_id) %}{% endif %}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td class="history-actions">
                                        {% set cancellable_statuses = ['Pending Mentor', 'Pending Incharge', 'Approved'] %}
                                        {% if req.status in cancellable_statuses %}
                                        <button type="button"
                                                class="admin-btn reject cancel-btn-modal"
                                                data-request-id="{{ req.id }}"
                                                data-request-name="{{ req.component_name }}">
                                            Cancel
                                        </button>
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- --- END: Tab 3 --- -->

        </div><!-- End Tab Container -->
    </div><!-- End Student Container -->

    <!-- START: Cancellation Modal (from previous step) -->
    <div id="cancel-modal" class="modal-backdrop" hidden>
        <div class="modal-content">
            <form id="cancel-modal-form" method="POST">
                <div class="modal-header">
                    <h3 id="cancel-modal-title">Cancel Request</h3>
                    <button type="button" class="modal-close-btn" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <p>Please provide a mandatory reason for cancelling the request for <strong id="cancel-modal-component-name"></strong>.</p>
                    <div class="form-group">
                        <label for="cancel_remarks_student">Cancellation Remarks:</label>
                        <textarea id="cancel_remarks_student" name="cancel_remarks" rows="3" placeholder="e.g., No longer required..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="admin-btn" data-dismiss="modal" style="background-color: var(--color-grey);">Close</button>
                    <button type="submit" class="admin-btn reject">Submit Cancellation</button>
                </div>
            </form>
        </div>
    </div>
    <!-- END: Cancellation Modal -->

    <!-- Component Row Template (for all forms) -->
    <template id="component-row-template">
        <div class="component-row">
            <div class="form-group">
                <label>Component Name:</label>
                <input type="text" list="component-datalist" name="component[]" class="component-search" placeholder="Type or select component" required>
            </div>
            <div class="form-group">
                <label>Quantity:</label>
                <input type="number" name="quantity[]" min="1" max="10" value="1" required>
            </div>
            <button type="button" class="remove-row-btn">X</button>
        </div>
    </template>

    <script>
        // --- RE-ADDED Main Tab Switching ---
        function openMainTab(evt, tabName) {
            var i, tabContent, tabLinks;
            tabContent = document.getElementsByClassName("main-tab-content");
            for (i = 0; i < tabContent.length; i++) tabContent[i].style.display = "none";
            tabLinks = document.getElementsByClassName("tab-link");
            for (i = 0; i < tabLinks.length; i++) tabLinks[i].className = tabLinks[i].className.replace(" active", "");
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        // --- NEW SCRIPT for Selection/Form Screen Switching ---
        const selectionScreen = document.getElementById('request-selection-screen');
        const formScreen = document.getElementById('request-form-screen');
        const backBtn = document.getElementById('back-to-selection-btn');
        const startBtns = document.querySelectorAll('.start-request-btn');
        const allForms = document.querySelectorAll('.request-form-container');

        startBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const formId = this.getAttribute('data-form-id');

                // Hide selection screen, show form screen
                selectionScreen.style.display = 'none';
                formScreen.style.display = 'block';

                // Hide all forms first
                allForms.forEach(f => f.style.display = 'none');

                // Show the specific form that was clicked
                document.getElementById(formId).style.display = 'block';
            });
        });

        backBtn.addEventListener('click', function() {
            // Hide form screen, show selection screen
            formScreen.style.display = 'none';
            selectionScreen.style.display = 'block';

            // Hide all forms
            allForms.forEach(f => f.style.display = 'none');
        });
        // --- END NEW SCRIPT ---

        // --- Dynamic Component Row Logic ---
        document.querySelectorAll('.add-component-btn').forEach(button => {
            const listId = button.previousElementSibling.id;
            button.addEventListener('click', function() {
                const template = document.getElementById('component-row-template');
                const clone = template.content.cloneNode(true);
                const componentList = document.getElementById(listId);
                clone.querySelector('.remove-row-btn').addEventListener('click', function(e) {
                    e.target.closest('.component-row').remove();
                });
                componentList.appendChild(clone);
            });
        });

        // --- Cancellation Modal JS (from previous step) ---
        const cancelModal = document.getElementById('cancel-modal');
        const cancelModalForm = document.getElementById('cancel-modal-form');
        const cancelModalComponentName = document.getElementById('cancel-modal-component-name');
        const cancelModalTitle = document.getElementById('cancel-modal-title');

        // Open modal
        document.querySelectorAll('.cancel-btn-modal').forEach(button => {
            button.addEventListener('click', function() {
                const reqId = this.getAttribute('data-request-id');
                const reqName = this.getAttribute('data-request-name');
                cancelModalForm.action = `/cancel_request/${reqId}`;
                cancelModalComponentName.textContent = reqName;
                cancelModalTitle.textContent = `Cancel Request #${reqId}`;
                cancelModalForm.querySelector('textarea').value = '';
                cancelModal.hidden = false;
            });
        });

        // Close modal
        cancelModal.querySelectorAll('[data-dismiss="modal"]').forEach(button => {
            button.addEventListener('click', function() {
                cancelModal.hidden = true;
            });
        });
        cancelModal.addEventListener('click', function(e) {
            if (e.target === cancelModal) {
                cancelModal.hidden = true;
            }
        });
        document.querySelectorAll('.disclaimer-checkbox').forEach((checkbox) => {
  checkbox.addEventListener('change', (e) => {
    const formId = e.target.id.split('-')[2]; // extract form id part
    const submitBtn = document.getElementById(`submit-btn-${formId}`);
    submitBtn.disabled = !e.target.checked;
  });
});
    </script>
</body>
</html>