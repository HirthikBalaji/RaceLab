<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faculty Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .component-row {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .component-row .form-group { margin-bottom: 0; }
        .component-row .form-group:first-child { flex-grow: 3; }
        .component-row .form-group:nth-child(2) { flex-grow: 1; }
        .remove-row-btn {
            background-color: var(--color-red);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.5rem;
            cursor: pointer;
            height: 40px;
            margin-top: 1.1rem;
        }
        .remove-row-btn:hover { background-color: var(--color-red-hover); }
        #add-component-btn {
            background-color: var(--color-grey);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand">
            <img src="{{ url_for('static', filename='bannerlogo.jpg') }}" alt="Logo" class="navbar-logo">
            RACE Lab - FACULTY PORTAL
        </div>
        <div class="navbar-user">
            Logged in as: <strong>{{ user.name }} ({{ user.department }})</strong>
            <a href="{{ url_for('logout') }}" class="logout-button">Logout</a>
        </div>
    </nav>

    <div class="student-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}{% for category, message in messages %}
            <div class="flash-{{ category }}">{{ message }}</div>
            {% endfor %}{% endif %}
        {% endwith %}

        <div class="tab-container">
            <div class="tab-nav">
                <button class="tab-link active" onclick="openTab(event, 'new_request')">New Request</button>
                <button class="tab-link" onclick="openTab(event, 'availability')">Component Availability</button>
                <button class="tab-link" onclick="openTab(event, 'history')">My Request History</button>
            </div>

            <!-- TAB: New Request -->
            <div id="new_request" class="tab-content" style="display: block;">

                <!-- Form 1: Request Existing Component -->
                <h3>Request Existing Component (Borrow)</h3>
                <p>Request components that are already available in the lab. This request will be sent directly to the Lab Incharge for approval.</p>
                <form action="{{ url_for('faculty_request') }}" method="POST" class="request-form">
                    <input type="hidden" name="request_type" value="borrow">
                    <datalist id="component-datalist">
                        {% for component in available_components %}
                        <option value="{{ component.name }}"></option>
                        {% endfor %}
                    </datalist>

                    <h4>Components</h4>
                    <div id="component-list">
                        <div class="component-row">
                            <div class="form-group">
                                <label for="component_1">Component Name:</label>
                                <input type="text" list="component-datalist" id="component_1" name="component[]" class="component-search" placeholder="Type or select component" required>
                            </div>
                            <div class="form-group">
                                <label for="quantity_1">Quantity:</label>
                                <input type="number" id="quantity_1" name="quantity[]" min="1" max="10" value="1" required>
                            </div>
                        </div>
                    </div>

                    <button type="button" id="add-component-btn">+ Add Another Component</button>
                    <hr style="margin: 1.5rem 0;">
                    <h4>Request Details</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="return_date">Expected Return Date (for all items):</label>
                            <input type="date" id="return_date" name="return_date" min="{{ today }}" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="project_description">Project / Purpose:</label>
                        <textarea id="project_description" name="project_description" rows="3" placeholder="Briefly describe your project or purpose..." required></textarea>
                    </div>
                    <button type="submit" class="submit-button">Submit Borrow Request</button>
                </form>

                <hr style="margin: 3rem 0;">

                <!-- Form 2: Request New Component Purchase -->
                <h3>Request New Component Purchase</h3>
                <p>Request a component that is not currently in the lab inventory. This request will be sent to the HOD for approval.</p>
                <form action="{{ url_for('faculty_request') }}" method="POST" class="request-form">
                    <input type="hidden" name="request_type" value="purchase">
                    <div class="form-row">
                        <div class="form-group" style="flex-grow: 2;">
                            <label for="purchase_component_name">Component Name:</label>
                            <input type="text" id="purchase_component_name" name="purchase_component_name" placeholder="e.g., Raspberry Pi 5 8GB" required>
                        </div>
                        <div class="form-group">
                            <label for="purchase_quantity">Quantity:</label>
                            <input type="number" id="purchase_quantity" name="purchase_quantity" min="1" value="1" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="purchase_link">Purchase Link (Optional):</label>
                        <input type="url" id="purchase_link" name="purchase_link" placeholder="https://www.vendor.com/product-link">
                    </div>
                    <div class="form-group">
                        <label for="purchase_project">Justification / Project:</label>
                        <textarea id="purchase_project" name="purchase_project" rows="3" placeholder="Briefly describe why this component is needed..." required></textarea>
                    </div>
                    <button type="submit" class="admin-btn approve">Submit Purchase Request</button>
                </form>
            </div>

            <!-- TAB: Component Availability -->
            <div id="availability" class="tab-content">
                <h3>Component Availability</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Component</th>
                                <th>Total</th>
                                <th>Working</th>
                                <th>Not Working</th>
                                <th>Issued</th>
                                <th>Available</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for component in components %}
                            <tr>
                                <td>{{ component.name }}</td>
                                <td>{{ component.total_quantity }}</td>
                                <td>{{ component.working_quantity }}</td>
                                <td>{{ component.not_working_quantity }}</td>
                                <td>{{ component.issued_quantity }}</td>
                                <td><strong>{{ component.available_for_issue }}</strong></td>
                                <td>
                                    {% if component.available_for_issue == 0 %}<span class="status out-of-stock">Out of Stock</span>
                                    {% elif component.available_for_issue < 10 %}<span class="status low-stock">Low Stock</span>
                                    {% else %}<span class="status in-stock">In Stock</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TAB: Request History -->
            <div id="history" class="tab-content">
                <h3>My Request History</h3>
                <div class="table-container wide-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Req ID</th>
                                <th>Type</th>
                                <th>Component</th>
                                <th>Qty</th>
                                <th>Status</th>
                                <th>HOD Remarks</th>
                                <th>Incharge Remarks</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if not my_requests %}
                                <tr><td colspan="7">You have not made any requests.</td></tr>
                            {% else %}
                                {% for req in my_requests %}
                                <tr>
                                    <td>{{ req.id }}</td>
                                     <td>
                                        {% if req.get('request_type') == 'purchase' %}
                                            <span class="status low-stock">Purchase</span>
                                        {% else %}
                                            <span class="status status-issued">Borrow</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ req.component_name }}</td>
                                    <td>{{ req.quantity }}</td>
                                    <td>
                                        {% set status_text = req.status | replace('-', ' ') | title %}
                                        <span class="status status-{{ req.status | lower | replace(' ', '-') }}">{{ status_text }}</span>
                                    </td>
                                    <td><small>{{ req.get('hod_remarks', '-') }}</small></td>
                                    <td><small>{{ req.get('incharge_remarks', '-') }}</small></td>
                                    <td>
                                        {% set cancellable_statuses = ['Pending Mentor', 'Pending Incharge', 'Approved', 'Pending Purchase'] %}
                                        {% if req.status in cancellable_statuses %}
                                        <button type="button"
                                                class="admin-btn reject cancel-btn-modal"
                                                style="padding: 0.2rem 0.5rem; font-size: 0.75rem;"
                                                data-request-id="{{ req.id }}"
                                                data-request-name="{{ req.component_name }}">
                                            Cancel
                                        </button>
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Template for dynamic component rows -->
    <template id="component-row-template">
        <div class="component-row">
            <div class="form-group">
                <label>Component Name:</label>
                <input type="text" list="component-datalist" name="component[]" class="component-search" placeholder="Type or select component" required>
            </div>
            <div class="form-group">
                <label>Quantity:</label>
                <input type="number" name="quantity[]" min="1" max="10" value="1" required>
            </div>
            <button type="button" class="remove-row-btn">X</button>
        </div>
    </template>
    <div id="cancel-modal" class="modal-backdrop" hidden>
        <div class="modal-content">
            <form id="cancel-modal-form" method="POST">
                <div class="modal-header">
                    <h3 id="cancel-modal-title">Cancel Request</h3>
                    <button type="button" class="modal-close-btn" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <p>Please provide a mandatory reason for cancelling the request for <strong id="cancel-modal-component-name"></strong>.</p>
                    <div class="form-group">
                        <label for="cancel_remarks_student">Cancellation Remarks:</label>
                        <textarea id="cancel_remarks_student" name="cancel_remarks" rows="3" placeholder="e.g., No longer required..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="admin-btn" data-dismiss="modal" style="background-color: var(--color-grey);">Close</button>
                    <button type="submit" class="admin-btn reject">Submit Cancellation</button>
                </div>
            </form>
        </div>
    </div>
    <script>
        // Tab switching logic
        function openTab(evt, tabName) {
            var i, tabContent, tabLinks;
            tabContent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabContent.length; i++) tabContent[i].style.display = "none";
            tabLinks = document.getElementsByClassName("tab-link");
            for (i = 0; i < tabLinks.length; i++) tabLinks[i].className = tabLinks[i].className.replace(" active", "");
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        // Dynamic row logic
        document.getElementById('add-component-btn').addEventListener('click', function() {
            const template = document.getElementById('component-row-template');
            const clone = template.content.cloneNode(true);
            const componentList = document.getElementById('component-list');
            clone.querySelector('.remove-row-btn').addEventListener('click', function(e) {
                e.target.closest('.component-row').remove();
            });
            componentList.appendChild(clone);
        });
        // --- START: New Modal Script ---
        const cancelModal = document.getElementById('cancel-modal');
        const cancelModalForm = document.getElementById('cancel-modal-form');
        const cancelModalComponentName = document.getElementById('cancel-modal-component-name');
        const cancelModalTitle = document.getElementById('cancel-modal-title');

        // Open modal
        document.querySelectorAll('.cancel-btn-modal').forEach(button => {
            button.addEventListener('click', function() {
                const reqId = this.getAttribute('data-request-id');
                const reqName = this.getAttribute('data-request-name');

                // Set form action
                cancelModalForm.action = `/cancel_request/${reqId}`;
                // Set modal text
                cancelModalComponentName.textContent = reqName;
                cancelModalTitle.textContent = `Cancel Request #${reqId}`;
                // Reset textarea
                cancelModalForm.querySelector('textarea').value = '';
                // Show modal
                cancelModal.hidden = false;
            });
        });

        // Close modal
        cancelModal.querySelectorAll('[data-dismiss="modal"]').forEach(button => {
            button.addEventListener('click', function() {
                cancelModal.hidden = true;
            });
        });
        // Also close by clicking backdrop
        cancelModal.addEventListener('click', function(e) {
            if (e.target === cancelModal) {
                cancelModal.hidden = true;
            }
        });
        // --- END: New Modal Script ---
    </script>
</body>
</html>