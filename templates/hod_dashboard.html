<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChairPerson Dashboard</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='icons/favicon.ico') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand">
            <img src="{{ url_for('static', filename='bannerlogo.jpg') }}" alt="Logo" class="navbar-logo">
            RACE Lab - ChairPerson
        </div>
        <div class="navbar-user">
            Logged in as: <strong>{{ user.name }}</strong>
            <a href="{{ url_for('logout') }}" class="logout-button">Logout</a>
        </div>
    </nav>

    <div class="student-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}{% for category, message in messages %}
            <div class="flash-{{ category }}">{{ message }}</div>
            {% endfor %}{% endif %}
        {% endwith %}

        <div class="tab-container">
            <div class="tab-nav">
                <button class="tab-link active" onclick="openTab(event, 'history')">Request History</button>
                <button class="tab-link" onclick="openTab(event, 'availability')">Component Availability</button>
                <button class="tab-link" onclick="openTab(event, 'reports')">Reports</button>
            </div>

            <div id="history" class="tab-content" style="display: block;">
                <h3>Request History (All Requests)</h3>
                <div class="table-container wide-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Req ID</th>
                                <th>Batch ID</th>
                                <th>User</th>
                                <th>Component</th>
                                <th>Qty</th>
                                <th>Drawer #</th> <th>Type</th>
                                <th>Status</th>
                                <th>Timestamps</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if not other_requests %}
                                <tr><td colspan="9">There are no requests in the history.</td></tr> {% else %}
                                {% for req in other_requests %}
                                <tr>
                                    <td>{{ req.id }}</td>
                                    <td><small>{{ req.get('batch_id', 'N/A') }}</small></td>
                                    <td>{{ req.student_name }}<br><small>{{ req.student_email }}</small></td>
                                    <td>{{ req.component_name }}</td>
                                    <td>{{ req.quantity }}</td>
                                    <td><strong>{{ req.get('drawer_number', '-') }}</strong></td> <td>
                                        {% if req.get('request_type') == 'purchase' %}
                                            <span class="status low-stock">Purchase</span>
                                        {% else %}
                                            <span class="status status-issued">Borrow</span>
                                        {% endif %}
                                    </td>
                                    {% set status_text = req.status | replace('-', ' ') | title %}
                                    <td><span class="status status-{{ req.status | lower | replace(' ', '-') }}">{{ status_text }}</span></td>
                                    <td>
                                        {% if req.status == 'Rejected' %}
                                            <small>Rej: {{ req.approval_timestamp or req.hod_approval_timestamp or req.mentor_approval_timestamp }}</small>
                                        {% elif req.status == 'ISSUED' %}
                                            <small>I: {{ req.issue_timestamp }}</small>
                                        {% elif req.status == 'Returned' %}
                                            <small>R: {{ req.actual_return_timestamp }}</small>
                                        {% elif req.status == 'Purchased' %}
                                            <small>P: {{ req.approval_timestamp }}</small>
                                        {% else %}
                                            <small>-</small>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="availability" class="tab-content">
                <h3>Component Availability</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Component</th>
                                <th>Total Qty</th>
                                <th>Working Qty</th>
                                <th>Not Working Qty</th>
                                <th>Issued Qty</th>
                                <th>Available for Issue</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for component in components %}
                            <tr>
                                <td>{{ component.name }}</td>
                                <td>{{ component.total_quantity }}</td>
                                <td>{{ component.working_quantity }}</td>
                                <td>{{ component.not_working_quantity }}</td>
                                <td>{{ component.issued_quantity }}</td>
                                <td><strong>{{ component.available }}</strong></td> <td>
                                    {% if component.available <= 0 %} <span class="status out-of-stock">Out of Stock</span>
                                    {% elif component.available < 10 %} <span class="status low-stock">Low Stock</span>
                                    {% else %}
                                        <span class="status in-stock">In Stock</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="reports" class="tab-content">
                <h3>Reports & Auditing</h3>
                <h4>Student Request Report</h4>
                <p>Download a complete history of all student requests in CSV format.</p>
                <div class="admin-actions">
                    <a href="{{ url_for('admin_download_report') }}" class="admin-btn download">
                        Download Request Report (CSV)
                    </a>
                </div>
                <h4>Inventory Audit Log</h4>
                <p>Download a structured CSV log of all inventory changes (approvals, returns, manual updates).</p>
                <div class="admin-actions">
                    <a href="{{ url_for('admin_download_audit_log') }}" class="admin-btn download">
                        Download Audit Log (CSV)
                    </a>
                </div>
            </div>
        </div>
        <script>
            function openTab(evt, tabName) {
                var i, tabContent, tabLinks;
                tabContent = document.getElementsByClassName("tab-content");
                for (i = 0; i < tabContent.length; i++) tabContent[i].style.display = "none";
                tabLinks = document.getElementsByClassName("tab-link");
                for (i = 0; i < tabLinks.length; i++) tabLinks[i].className = tabLinks[i].className.replace(" active", "");
                document.getElementById(tabName).style.display = "block";
                evt.currentTarget.className += " active";
            }
        </script>
    </div>
</body>
</html>